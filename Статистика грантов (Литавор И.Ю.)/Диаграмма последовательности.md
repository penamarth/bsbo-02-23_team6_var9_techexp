<img width="2274" height="1819" alt="image" src="https://github.com/user-attachments/assets/4efa34cd-6da6-46c3-877b-51fc4cf34fe8" />


@startuml
actor "Инвестор" as Investor
actor "Независимый эксперт" as Expert
participant "UI" as UI
participant "GrantStatisticsFacade" as StatsFacade
participant "IGrantStatisticsRepository" as StatsRepo
participant "IGrantApplicationRepository" as ApplicationRepo
participant "NotificationService" as NotifyService
participant "AuthorizationService" as AuthService
participant "Database" as DB

Investor -> UI: Запрос статистики грантов
UI -> StatsFacade: GetGrantStatistics(filters: StatisticsFilters)
StatsFacade -> AuthService: ValidateAccess(userId: uInt32, role: "Investor")
AuthService --> StatsFacade: AccessGranted

StatsFacade -> StatsRepo: GetGeneralStatistics(filters: StatisticsFilters)
StatsRepo -> DB: SELECT COUNT(*), status, \nAVG(funding_amount) FROM grant_applications \nWHERE date BETWEEN startDate AND endDate
DB --> StatsRepo: Statistics data
StatsRepo --> StatsFacade: GeneralStatistics object

StatsFacade -> StatsRepo: GetStatusDistribution(filters: StatisticsFilters)
StatsRepo -> DB: SELECT status, COUNT(*) as count \nFROM grant_applications GROUP BY status
DB --> StatsRepo: Status distribution data
StatsRepo --> StatsFacade: StatusDistribution object

StatsFacade -> StatsRepo: GetFundingStatistics(filters: StatisticsFilters)
StatsRepo -> DB: SELECT SUM(funding_amount), \nAVG(funding_amount), MIN(funding_amount), \nMAX(funding_amount) FROM grant_applications
DB --> StatsRepo: Funding statistics
StatsRepo --> StatsFacade: FundingStatistics object

StatsFacade -> UI: GrantStatistics object
UI --> Investor: Отображает статистику: общее количество,\nраспределение по статусам, финансирование

Expert -> UI: Запрос статистики по экспертизе
UI -> StatsFacade: GetExpertStatistics(expertId: uInt32, filters: StatisticsFilters)
StatsFacade -> AuthService: ValidateAccess(expertId: uInt32, role: "Expert")
AuthService --> StatsFacade: AccessGranted

StatsFacade -> StatsRepo: GetExpertWorkloadStatistics(expertId: uInt32, filters: StatisticsFilters)
StatsRepo -> DB: SELECT COUNT(*) as total_applications,\nCOUNT(CASE WHEN status = 'reviewed' THEN 1 END) as reviewed,\nAVG(review_duration) as avg_review_time\nFROM grant_applications WHERE expert_id = expertId
DB --> StatsRepo: Expert workload data
StatsRepo --> StatsFacade: ExpertStatistics object

StatsFacade -> ApplicationRepo: GetApplicationsByExpert(expertId: uInt32, filters: StatisticsFilters)
ApplicationRepo -> DB: SELECT * FROM grant_applications \nWHERE expert_id = expertId AND date BETWEEN startDate AND endDate
DB --> ApplicationRepo: Applications list
ApplicationRepo --> StatsFacade: List<Application> objects

StatsFacade -> UI: ExpertStatistics object
UI --> Expert: Отображает статистику эксперта: нагрузка,\nсреднее время рассмотрения, эффективность

group Ежедневное обновление статистики (системный процесс)
StatsFacade -> StatsRepo: UpdateDailyStatistics()
StatsRepo -> DB: INSERT INTO statistics_daily (date, \napplications_count, approved_count, total_funding)
DB --> StatsRepo: Update confirmed
end

Investor -> UI: Запрос отчета по статистике
UI -> StatsFacade: GenerateStatisticsReport(filters: StatisticsFilters, format: ReportFormat)
StatsFacade -> StatsRepo: GenerateReport(filters: StatisticsFilters, format: ReportFormat)
StatsRepo -> DB: Complex queries for report generation
DB --> StatsRepo: Report data
StatsRepo --> StatsFacade: Report file

StatsFacade -> UI: Report file
UI --> Investor: Предлагает скачать отчет в выбранном формате

@enduml
