![Диаграмма последовательности - Выдача гранта](https://i.imgur.com/BDPg5AV.png) 

```
@startuml
title Диаграмма последовательности: Выдача гранта

actor Инвестор
participant "Пользователь" as User
participant "GrantSystemFacade" as Facade
participant "IAppRepository" as AppRepo
participant "IUserRepository" as UserRepo
participant "IPaymentService" as PaymentService
participant "INotifyService" as NotifyService
participant "PaymentGatewayAPI" as PaymentAPI
participant "EmailServiceAPI" as EmailAPI

' Основной поток
Инвестор -> Facade: approveApplication(appId, amount)
activate Facade

Facade -> AppRepo: findById(appId)
activate AppRepo
AppRepo --> Facade: GrantApplication
deactivate AppRepo

note right of Facade: Проверяет что статус = "APPROVED"\nи сумма > 0
note right of Facade: Создает новый Grant\nс amount, startDate,\nendDate, status="APPROVED"

Facade -> AppRepo: save(grant)
activate AppRepo
AppRepo --> Facade: сохраненный Grant
deactivate AppRepo

Facade -> Facade: setStatus("GRANT_ISSUED")
Facade -> AppRepo: update(GrantApplication)
activate AppRepo
AppRepo --> Facade: обновленная заявка
deactivate AppRepo

Facade -> Facade: getApplicantId()
Facade -> UserRepo: findById(applicantId)
activate UserRepo
UserRepo --> Facade: Applicant
deactivate UserRepo

Facade -> NotifyService: sendNotification(Applicant,\n"Ваш грант одобрен")
activate NotifyService
NotifyService -> EmailAPI: sendEmail(to, subject, body)
activate EmailAPI
EmailAPI --> NotifyService: true
deactivate EmailAPI
NotifyService --> Facade: уведомление отправлено
deactivate NotifyService

Facade -> PaymentService: processPayment(grant)
activate PaymentService
PaymentService -> PaymentAPI: processPayment(amount, recipient)
activate PaymentAPI

group Успешный платеж
    PaymentAPI --> PaymentService: Result(success=true)
    deactivate PaymentAPI
    
    PaymentService -> PaymentService: setStatus("DISBURSED")
    PaymentService -> AppRepo: save(grant)
    activate AppRepo
    AppRepo --> PaymentService: обновленный Grant
    deactivate AppRepo
    
    PaymentService -> NotifyService: sendNotification(Investor,\n"Грант выплачен соискателю")
    activate NotifyService
    NotifyService -> EmailAPI: sendEmail(to, subject, body)
    activate EmailAPI
    EmailAPI --> NotifyService: true
    deactivate EmailAPI
    NotifyService --> PaymentService: уведомление отправлено
    deactivate NotifyService
    
    PaymentService --> Facade: true
    deactivate PaymentService
    
    Facade --> User: Показывает сообщение\nоб успешной выдаче гранта
    Facade --> Инвестор: Grant
    deactivate Facade
end

group Ошибка платежа
    PaymentAPI --> PaymentService: Result(success=false)
    deactivate PaymentAPI
    
    PaymentService -> PaymentService: setStatus("PAYMENT_FAILED")
    PaymentService -> AppRepo: save(grant)
    activate AppRepo
    AppRepo --> PaymentService: обновленный Grant
    deactivate AppRepo
    
    PaymentService -> NotifyService: sendNotification(Investor,\n"Ошибка при выплате гранта")
    activate NotifyService
    NotifyService -> EmailAPI: sendEmail(to, subject, body)
    activate EmailAPI
    EmailAPI --> NotifyService: true
    deactivate EmailAPI
    NotifyService --> PaymentService: уведомление отправлено
    deactivate NotifyService
    
    PaymentService -> Facade: выбрасывает исключение\nPaymentFailedException
    deactivate PaymentService
    
    Facade --> User: Показывает сообщение\nоб ошибке выплаты
    Facade --> Инвестор: выбрасывает исключение
    deactivate Facade
end
@enduml
```
