![Диаграмма последовательности - Выдача гранта](https://imgur.com/a/7CW951U.png)

```
@startuml
title Диаграмма последовательности: Выдача гранта

actor Инвестор as Investor
participant GrantSystemUI as UI
participant GrantSystemFacade as Facade
participant INotifyService as NotifyService
participant IPaymentService as PaymentService
participant IAppRepository as AppRepo
participant IGrantRepository as GrantRepo
participant IUserRepository as UserRepo

Investor -> UI: Запрос на выдачу гранта\n(approveApplication)
activate UI

UI -> Facade: approveApplication(appId, amount)
activate Facade

' 1. Получение заявки
Facade -> AppRepo: findById(appId)
activate AppRepo
AppRepo --> Facade: GrantApplication
deactivate AppRepo

' 2. Проверка статуса и валидация
Facade -> Facade: Проверяет что статус = "APPROVED"\nи сумма > 0

' 3. Создание объекта Grant
Facade -> Facade: Создает новый Grant\nс amount, startDate, endDate, status="APPROVED"

' 4. Сохранение гранта в БД
Facade -> GrantRepo: save(grant)
activate GrantRepo
GrantRepo --> Facade: сохраненный Grant
deactivate GrantRepo

' 5. Обновление статуса заявки
Facade -> GrantApplication: setStatus("GRANT_ISSUED")
activate GrantApplication
GrantApplication --> Facade: ok
deactivate GrantApplication

Facade -> AppRepo: update(GrantApplication)
activate AppRepo
AppRepo --> Facade: обновленная заявка
deactivate AppRepo

' 6. Получение информации о соискателе
Facade -> GrantApplication: getApplicantId()
activate GrantApplication
GrantApplication --> Facade: applicantId
deactivate GrantApplication

Facade -> UserRepo: findById(applicantId)
activate UserRepo
UserRepo --> Facade: Applicant
deactivate UserRepo

' 7. Отправка уведомления соискателю
Facade -> NotifyService: sendNotification(Applicant, \n"Ваш грант одобрен")
activate NotifyService
NotifyService --> Facade: уведомление отправлено
deactivate NotifyService

' 8. Обработка выплаты
Facade -> PaymentService: processPayment(grant)
activate PaymentService

PaymentService -> PaymentService: Выполняет платеж\nчерез платежный шлюз
PaymentService --> Facade: true (платеж успешен)
deactivate PaymentService

' 9. Обновление статуса гранта после выплаты
Facade -> Grant: setStatus("DISBURSED")
activate Grant
Grant --> Facade: ok
deactivate Grant

Facade -> GrantRepo: save(grant)
activate GrantRepo
GrantRepo --> Facade: обновленный Grant
deactivate GrantRepo

' 10. Уведомление инвестора
Facade -> NotifyService: sendNotification(Investor, \n"Грант выплачен соискателю")
activate NotifyService
NotifyService --> Facade: уведомление отправлено
deactivate NotifyService

Facade --> UI: созданный Grant
deactivate Facade

UI --> Investor: Показывает сообщение об успешной выдаче гранта
deactivate UI

' Альтернативный сценарий: ошибка платежа
note over PaymentService: Альтернативный поток: ошибка платежа
Facade -> PaymentService: processPayment(grant)
activate PaymentService
PaymentService --> Facade: false (платеж не удался)
deactivate PaymentService

Facade -> Grant: setStatus("PAYMENT_FAILED")
activate Grant
Grant --> Facade: ok
deactivate Grant

Facade -> GrantRepo: save(grant)
activate GrantRepo
GrantRepo --> Facade: обновленный Grant
deactivate GrantRepo

Facade -> NotifyService: sendNotification(Investor, \n"Ошибка при выплате гранта")
activate NotifyService
NotifyService --> Facade: уведомление отправлено
deactivate NotifyService

Facade --> UI: выбрасывает исключение PaymentFailedException
deactivate Facade

@enduml
```
