# **Подробное описание диаграммы последовательности "Выдача гранта"**

## **Рамки и интеграция**
**Компонент «Выдача гранта»** представляет собой завершающую стадию финансового цикла в системе управления исследовательскими грантами. Он соединяет решение инвестора о финансировании с фактическим переводом денежных средств, обеспечивая сквозную автоматизацию от утверждения до банковского перевода. **Модуль работает через центральный фасад** (`GrantSystemFacade`), который координирует взаимодействие с хранилищами данных (`IAppRepository`, `IUserRepository`), финансовыми сервисами (`IPaymentService`) и системой коммуникаций (`INotifyService`).

## **Уровень и финансовый контекст**
**Это транзакционная финансовая операция**, которая включает:

- **Авторизацию и проверку прав** (только инвестор может утверждать выплату)
- **Валидацию бизнес-правил** (статус заявки, корректность суммы)
- **Создание финансового обязательства** (объект `Grant`)
- **Выполнение банковской операции** через внешний шлюз
- **Обновление статусов** в системе учета
- **Информирование всех участников** процесса

## **Основной исполнитель и заинтересованные лица**

### **Основной исполнитель: Инвестор (Investor)**
- **Роль:** `Investor` (специализированный тип пользователя с правами на финансовые решения)
- **Действие:** Утверждает выплату гранта через пользовательский интерфейс
- **Авторизация:** Предварительно аутентифицирован в системе

### **Заинтересованные лица и их требования:**

| Роль | Требования | Реализация в системе |
|------|-----------|------------------------|
| **Инвестор** | Простота операции, мгновенное подтверждение, прозрачность | UI с одной кнопкой "Выдать грант", возврат объекта `Grant`, уведомление о результате |
| **Соискатель (Applicant)** | Быстрое уведомление об одобрении, четкие условия | Email сразу после утверждения, до фактического перевода средств |
| **Финансовый отдел** | Фиксация операции, аудиторский след, отчетность | Сохранение `Grant` в репозитории, четкие статусы ("GRANT_ISSUED", "DISBURSED") |
| **Администратор системы** | Обработка ошибок, логирование, возможность повтора | Механизм исключений при сбое платежа, сохранение статуса "PAYMENT_FAILED" |

## **Предусловия (Preconditions)**

### **1. Аутентификация и права:**
- Пользователь выполнил вход в систему (`GrantSystemFacade.login()`)
- Роль пользователя = "Investor"
- Сессия активна и валидна

### **2. Состояние заявки:**
- Заявка с `appId` существует в системе
- Статус заявки = "APPROVED" (уже прошла экспертизу и одобрена)
- Для заявки еще не создан грант (первая выплата)

### **3. Финансовые условия:**
- Сумма `amount` > 0 и прошла валидацию
- У инвестора достаточно средств на счете (проверяется платежной системой)
- Платежный шлюз доступен и оперативен

### **4. Технические условия:**
- Все репозитории (`IAppRepository`, `IUserRepository`) доступны
- Сервис уведомлений подключен к почтовому серверу
- Сеть между компонентами стабильна

## **Постусловия (Postconditions)**

### **Успешный сценарий:**
1. **Финансовый документ создан:** Новый объект `Grant` сохранен со статусом "APPROVED"
2. **Статус заявки обновлен:** `GrantApplication.status` изменен на "GRANT_ISSUED"
3. **Деньги переведены:** Платежная операция успешно выполнена через внешний шлюз
4. **Статус выплаты зафиксирован:** `Grant.status` изменен на "DISBURSED"
5. **Уведомления отправлены:**
   - Соискатель получил письмо об одобрении гранта
   - Инвестор получил подтверждение о successful выплате

### **Сценарий с ошибкой платежа:**
1. **Статус гранта зафиксирован:** `Grant.status` = "PAYMENT_FAILED"
2. **Уведомление отправлено:** Инвестор получил предупреждение о сбое
3. **Исключение передано:** `PaymentFailedException` проброшено на уровень UI
4. **Заявка остается в обработке:** Статус "GRANT_ISSUED" требует вмешательства администратора

## **Детальный основной успешный сценарий**

### **1. Инициация операции (Presentation Layer)**
**Контекст:** Инвестор просматривает список одобренных заявок и выбирает одну для финансирования  
**Данные:** `appId` (идентификатор выбранной заявки), `amount` (сумма гранта из заявки или вручную введенная)

### **2. Получение и проверка заявки (Business Logic Layer)**
**Проверка 1:** Существует ли заявка? (не null)  
**Проверка 2:** Статус заявки == "APPROVED"?  
**Проверка 3:** Для заявки еще не создан грант?

### **3. Создание объекта гранта (Domain Layer)**
**Логика расчета дат:**
- `startDate`: Текущая дата (дата утверждения)
- `endDate`: `startDate` + duration (из условий гранта)

**Финансовый документ:** Грант становится юридическим обязательством инвестора

### **4. Обновление статуса заявки (Data Layer)**
**Связь объектов:** Устанавливается ссылка из заявки на созданный грант  
**Транзакционность:** Этот шаг и предыдущий должны выполняться атомарно

### **5. Получение данных для уведомления (Data Access Layer)**
**Цель:** Получить контактные данные соискателя (email)  
**Оптимизация:** В реальной системе email может храниться прямо в заявке

### **6. Уведомление соискателя (Integration Layer)**
**Содержание письма:**
- Поздравление с одобрением
- Сумма гранта
- Сроки выполнения
- Следующие шаги

**Важно:** Письмо отправляется ДО фактического перевода денег

### **7. Выполнение платежа (Financial Integration Layer)**
**Интеграция с банком:** REST/SOAP вызов к платежному шлюзу  
**Безопасность:** TLS соединение, шифрование данных карты/счета  
**Идемпотентность:** Уникальный `idempotencyKey` для предотвращения дублирования

### **8. Обработка успешного платежа (Business Logic)**
**Аудит:** Фиксируется дата и время фактического перевода  
**Отчетность:** Статус "DISBURSED" сигнализирует об исполнении обязательства

### **9. Подтверждение инвестору (Notification Layer)**
**Коммуникация:** Инвестор получает финальное подтверждение  
**Юридический аспект:** Факт исполнения финансового обязательства

### **10. Возврат результата (Response Chain)**
**UX:** Четкое сообщение об успехе  
**Детали:** Возможность просмотреть детали операции (сумма, получатель, дата)

## **Расширения (альтернативные потоки)**

### **E1: Заявка не найдена**
**Причина:** Неверный `appId` или заявка удалена  
**Действие инвестора:** Обновить страницу, выбрать другую заявку

### **E2: Неверный статус заявки**
**Возможные статусы:**
- "DRAFT" — еще не подана
- "UNDER_REVIEW" — на экспертизе
- "REJECTED" — отклонена
- "GRANT_ISSUED" — уже выдан грант

**Решение:** Инвестор видит соответствующее сообщение

### **E3: Недостаточно средств у инвестора**
**Обнаружение:** На стороне банка/платежной системы  
**Обработка:**
- Статус гранта = "PAYMENT_FAILED"
- Инвестор уведомлен о необходимости пополнить счет
- Предложение повторить попытку позже

### **E4: Неверные реквизиты получателя**
**Причина:** Ошибочные банковские данные у соискателя  
**Действия:**
1. Уведомить инвестора об ошибке
2. Отправить соискателю запрос на актуализацию реквизитов
3. Приостановить выплату до исправления

### **E5: Технический сбой платежного шлюза**
**Стратегия:**
1. Логировать ошибку для администратора
2. Установить статус "PAYMENT_RETRY_PENDING"
3. Запланировать автоматическую повторную попытку через 5 минут

## **Специальные требования и их реализация**

| Требование | Реализация в коде | Технические детали |
|------------|------------------|-------------------|
| **Атомарность операций** | Транзакция охватывает шаги 3-4 (создание гранта + обновление заявки) | `@Transactional` аннотация на методе `approveApplication()` |
| **Идемпотентность** | Уникальный `transactionId` для каждого вызова `processPayment()` | Генерируется на основе `grantId + timestamp` |
| **Аудит действий** | Логирование всех вызовов репозиториев `save()` и `update()` | Аспект `AuditAspect` логирует кто, когда, что изменил |
| **Конфиденциальность данных** | Шифрование `amount` и реквизитов в БД | AES-256 шифрование полей `encryptedAmount`, `encryptedAccount` |
| **Производительность** | Кэширование часто читаемых данных (`User`, `GrantApplication`) | Redis кэш с TTL=5 минут для `User` объектов |

## **Технологии и типы данных**

### **Форматы данных:**
- `appId`: `UUID` или `BIGINT auto_increment`
- `amount`: `DECIMAL(15,2)` с точностью до копеек/центов
- `status`: `ENUM('APPROVED','GRANT_ISSUED','DISBURSED','PAYMENT_FAILED')`
- `dates`: `TIMESTAMP WITH TIME ZONE` (UTC)

### **Интерфейсы:**
1. **`IPaymentService`** → `PaymentGatewayAdapter` → `BankRestAPI`
2. **`INotifyService`** → `EmailServiceAdapter` → `SMTP`/`SendGrid`/`Mailchimp`
3. **`IAppRepository`** → `JpaRepository` → `PostgreSQL`
4. **`GrantSystemFacade`** → `REST Controller` → `Angular/React UI`

### **Конфигурация:**
```yaml
payment:
  gateway:
    url: https://api.payment-gateway.com/v2
    timeout: 10000
    retries: 3
    
grant:
  max-amount: 1000000
  default-duration-days: 365
  
notification:
  email-templates:
    grant-approved: /templates/grant_approved.html
    payment-success: /templates/payment_success.html
