https://imgur.com/a/pEUJPYl

# **Подробное описание диаграммы последовательности "Выдача гранта"**

## **Рамки и интеграция**
**Компонент «Выдача гранта»** представляет собой завершающую стадию финансового цикла в системе управления исследовательскими грантами. Он соединяет решение инвестора о финансировании с фактическим переводом денежных средств, обеспечивая сквозную автоматизацию от утверждения до банковского перевода. **Модуль работает через центральный фасад** (`GrantSystemFacade`), который координирует взаимодействие с хранилищами данных (`IAppRepository`, `IUserRepository`), финансовыми сервисами (`IPaymentService`) и системой коммуникаций (`INotifyService`).

## **Уровень и финансовый контекст**
**Это транзакционная финансовая операция**, которая включает:

- **Авторизацию и проверку прав** (только инвестор может утверждать выплату)
- **Валидацию бизнес-правил** (статус заявки, корректность суммы)
- **Создание финансового обязательства** (объект `Grant`)
- **Выполнение банковской операции** через внешний шлюз
- **Обновление статусов** в системе учета
- **Информирование всех участников** процесса

## **Основной исполнитель и заинтересованные лица**

### **Основной исполнитель: Инвестор (Investor)**
- **Роль:** `Investor` (специализированный тип пользователя с правами на финансовые решения)
- **Действие:** Утверждает выплату гранта через пользовательский интерфейс
- **Авторизация:** Предварительно аутентифицирован в системе

### **Заинтересованные лица и их требования:**

| Роль | Требования | Реализация в системе |
|------|-----------|------------------------|
| **Инвестор** | Простота операции, мгновенное подтверждение, прозрачность | UI с одной кнопкой "Выдать грант", возврат объекта `Grant`, уведомление о результате |
| **Соискатель (Applicant)** | Быстрое уведомление об одобрении, четкие условия | Email сразу после утверждения, до фактического перевода средств |
| **Финансовый отдел** | Фиксация операции, аудиторский след, отчетность | Сохранение `Grant` в репозитории, четкие статусы ("GRANT_ISSUED", "DISBURSED") |
| **Администратор системы** | Обработка ошибок, логирование, возможность повтора | Механизм исключений при сбое платежа, сохранение статуса "PAYMENT_FAILED" |

## **Предусловия (Preconditions)**

### **1. Аутентификация и права:**
- Пользователь выполнил вход в систему (`GrantSystemFacade.login()`)
- Роль пользователя = "Investor"
- Сессия активна и валидна

### **2. Состояние заявки:**
- Заявка с `appId` существует в системе
- Статус заявки = "APPROVED" (уже прошла экспертизу и одобрена)
- Для заявки еще не создан грант (первая выплата)

### **3. Финансовые условия:**
- Сумма `amount` > 0 и прошла валидацию
- У инвестора достаточно средств на счете (проверяется платежной системой)
- Платежный шлюз доступен и оперативен

### **4. Технические условия:**
- Все репозитории (`IAppRepository`, `IUserRepository`) доступны
- Сервис уведомлений подключен к почтовому серверу
- Сеть между компонентами стабильна

## **Постусловия (Postconditions)**

### **Успешный сценарий:**
1. **Финансовый документ создан:** Новый объект `Grant` сохранен со статусом "APPROVED"
2. **Статус заявки обновлен:** `GrantApplication.status` изменен на "GRANT_ISSUED"
3. **Деньги переведены:** Платежная операция успешно выполнена через внешний шлюз
4. **Статус выплаты зафиксирован:** `Grant.status` изменен на "DISBURSED"
5. **Уведомления отправлены:**
   - Соискатель получил письмо об одобрении гранта
   - Инвестор получил подтверждение о successful выплате

### **Сценарий с ошибкой платежа:**
1. **Статус гранта зафиксирован:** `Grant.status` = "PAYMENT_FAILED"
2. **Уведомление отправлено:** Инвестор получил предупреждение о сбое
3. **Исключение передано:** `PaymentFailedException` проброшено на уровень UI
4. **Заявка остается в обработке:** Статус "GRANT_ISSUED" требует вмешательства администратора

## **Детальный основной успешный сценарий**

### **1. Инициация операции (Presentation Layer)**
