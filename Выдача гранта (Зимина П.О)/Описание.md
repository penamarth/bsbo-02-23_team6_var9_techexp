# Подробное описание диаграммы последовательности "Выдача гранта" 
на основе вашего технического задания

## **Рамки и интеграция**

Модуль «Выдача гранта» является центральным финансовым компонентом информационной системы технической экспертизы. Он обеспечивает сквозной процесс выплаты грантовых средств от утверждения инвестором до фактического зачисления на счет соискателя, включая автоматизированное взаимодействие с бухгалтерским модулем и системой уведомлений. Модуль интегрирован через унифицированный фасад (`GrantSystemFacade`) с основными агрегатами системы: `GrantApplication`, `Grant`, `User`, а также со вспомогательными сервисами уведомлений и платежей.

## **Уровень и финансовый контекст**

Это **финансовая транзакционная задача**, охватывающая полный цикл денежной операции в грантовой системе:
- **Авторизация и контроль доступа** (роль "Investor")
- **Проверка бизнес-правил** (статус заявки, наличие средств)
- **Финансовая операция** через платежный шлюз
- **Бухгалтерский учет** (фиксация в репозиториях)
- **Аудиторский след** (логирование всех этапов)
- **Коммуникация с участниками** (система уведомлений)

## **Основной исполнитель и заинтересованные лица**

### **Основной исполнитель: Инвестор (Investor)**
- Роль: `Investor` (наследник `User`)
- Авторизованный пользователь с правами на утверждение выплат
- Доступ через UI (`GrantSystemUI`) к финансовым операциям

### **Заинтересованные лица и их требования:**

| Роль | Требования | Как реализовано в диаграмме |
|------|-----------|------------------------------|
| **Инвестор** | Простой интерфейс для утверждения выплат, прозрачность операций, мгновенное подтверждение | `GrantSystemUI` → `approveApplication()`, двустороннее уведомление |
| **Соискатель** | Оперативное уведомление, отслеживание статуса | `NotifyService.sendNotification()` после утверждения и после выплаты |
| **Бухгалтерия** | Автоматическая фиксация операций, отчетность | `GrantRepository.save()`, `AppRepository.update()`, статусы "GRANT_ISSUED"/"DISBURSED" |
| **Администратор** | Аудит операций, контроль ошибок | Логирование в репозиториях, обработка исключений `PaymentFailedException` |

## **Предусловия (Preconditions)**

1. **Авторизация и права доступа:**
   - Пользователь аутентифицирован через `GrantSystemFacade.login()`
   - Роль пользователя = "Investor" (тип `Investor` наследник `User`)
   - Доступ к методу `approveApplication()` в `GrantSystemFacade`

2. **Статус заявки:**
   - Заявка (`GrantApplication`) существует и найдена через `IAppRepository.findById()`
   - Статус заявки = "APPROVED" (прошла экспертизу `Review`)
   - Заявка не имеет связанного выданного гранта (`Grant`)

3. **Финансовые условия:**
   - Сумма гранта (`amount`) > 0 и валидирована
   - Бюджет инвестора (`Investor.budget`) достаточен (неявная проверка)
   - Платежный сервис (`IPaymentService`) доступен

4. **Техническая готовность:**
   - `PaymentService` интегрирован с `PaymentGatewayAPI`
   - `NotifyService` подключен к `EmailServiceAPI`
   - Все репозитории (`IAppRepository`, `IGrantRepository`, `IUserRepository`) оперативны

## **Постусловия (Postconditions)**

### **Основной успешный сценарий:**
1. **Создан финансовый документ:** Новый объект `Grant` сохранен в `IGrantRepository` со статусом "APPROVED"
2. **Обновлен статус заявки:** `GrantApplication.status` изменен на "GRANT_ISSUED" через `IAppRepository.update()`
3. **Выполнен денежный перевод:** `IPaymentService.processPayment()` успешно обработан через внешний платежный шлюз
4. **Обновлен статус выплаты:** `Grant.status` изменен на "DISBURSED"
5. **Зафиксирована операция в учете:** Все изменения сохранены в соответствующих репозиториях
6. **Уведомлены участники:**
   - Соискатель (`Applicant`) получает уведомление об одобрении
   - Инвестор получает уведомление об успешной выплате

### **Альтернативный сценарий (ошибка платежа):**
1. **Статус гранта зафиксирован:** `Grant.status` = "PAYMENT_FAILED"
2. **Уведомлен инвестор:** Получает сообщение об ошибке выплаты
3. **Выброшено исключение:** `PaymentFailedException` для обработки на UI
4. **Заявка остается в обрабатываемом состоянии:** `GrantApplication.status` = "GRANT_ISSUED" (требует повторной попытки)

## **Детальный основной успешный сценарий**

### **1. Инициация процесса (UI Layer)**
```
Инвестор → GrantSystemUI: approveApplication(appId, amount)
GrantSystemUI → GrantSystemFacade: approveApplication(appId, amount)
```
- **Аутентификация:** Уже выполнена ранее (предусловие)
- **Входные данные:** `appId` (идентификатор заявки), `amount` (сумма гранта)
- **Валидация:** Проверка формата данных на уровне UI

### **2. Получение и проверка заявки (Business Logic)**
```
GrantSystemFacade → IAppRepository: findById(appId)
IAppRepository → GrantSystemFacade: GrantApplication
GrantSystemFacade → (самопроверка): validateApplication(GrantApplication)
```
- **Проверки:**
  - Существование заявки
  - Статус = "APPROVED" (прошла экспертизу)
  - Отсутствие уже выданного гранта
  - Сумма `amount` соответствует бизнес-правилам

### **3. Создание объекта гранта (Domain Logic)**
```
GrantSystemFacade → (создание): new Grant(amount, startDate, endDate, "APPROVED")
GrantSystemFacade → IGrantRepository: save(grant)
IGrantRepository → GrantSystemFacade: сохраненный Grant
```
- **Бизнес-логика:**
  - `startDate`: Дата начала гранта (текущая дата)
  - `endDate`: Дата окончания (расчетная)
  - `status`: Инициализируется как "APPROVED"

### **4. Обновление статуса заявки (Data Layer)**
```
GrantSystemFacade → GrantApplication: setStatus("GRANT_ISSUED")
GrantSystemFacade → IAppRepository: update(GrantApplication)
```
- **Связь агрегатов:** Устанавливается связь `GrantApplication` → `Grant`
- **Атомарность:** Должна обеспечиваться на уровне транзакции

### **5. Получение данных соискателя (для уведомления)**
```
GrantSystemFacade → GrantApplication: getApplicantId()
GrantSystemFacade → IUserRepository: findById(applicantId)
IUserRepository → GrantSystemFacade: Applicant
```
- **Цель:** Для персонализированного уведомления
- **Конфиденциальность:** Передаются только необходимые для уведомления данные

### **6. Уведомление соискателя (Integration Layer)**
```
GrantSystemFacade → INotifyService: sendNotification(Applicant, "Ваш грант одобрен")
INotifyService → EmailServiceAPI: sendEmail(...)
```
- **Канал:** Email через внешний сервис
- **Контент:** Шаблонное сообщение с деталями гранта
- **Асинхронность:** В идеале должно выполняться асинхронно

### **7. Обработка платежа (Financial Integration)**
```
GrantSystemFacade → IPaymentService: processPayment(grant)
IPaymentService → PaymentGatewayAPI: processPayment(amount, recipient)
PaymentGatewayAPI → IPaymentService: Result(success)
IPaymentService → GrantSystemFacade: true
```
- **Интеграция:** С внешним платежным шлюзом
- **Безопасность:** TLS 1.3+, шифрование данных
- **Идемпотентность:** Гарантия от повторных списаний

### **8. Фиксация успешной выплаты (Data Update)**
```
GrantSystemFacade → Grant: setStatus("DISBURSED")
GrantSystemFacade → IGrantRepository: save(grant)
```
- **Аудит:** Фиксация даты и времени выплаты
- **Отчетность:** Для бухгалтерского модуля

### **9. Уведомление инвестора (Confirmation)**
```
GrantSystemFacade → INotifyService: sendNotification(Investor, "Грант выплачен")
```
- **Подтверждение:** Завершение финансовой операции
- **Юридическая значимость:** Факт исполнения обязательств

### **10. Возврат результата (Response Chain)**
```
GrantSystemFacade → GrantSystemUI: созданный Grant
GrantSystemUI → Инвестор: Показывает сообщение об успешной выдаче
```
- **Пользовательский опыт:** Понятное подтверждение успеха
- **Детализация:** Возможность просмотра деталей операции

## **Расширения (альтернативные потоки)**

### **E1: Ошибка авторизации/прав доступа**
- **Точка сбоя:** До вызова `approveApplication()`
- **Обработка:** `GrantSystemUI` не отображает кнопку выплаты для пользователей без роли "Investor"
- **Сообщение:** "Доступ запрещен. Недостаточно прав для финансовых операций"

### **E2: Заявка не найдена или неверный статус**
```
IAppRepository → GrantSystemFacade: null / не APPROVED
GrantSystemFacade → (валидация): выбрасывает ValidationException
GrantSystemFacade → GrantSystemUI: ошибка валидации
```
- **Коды ошибок:** 
  - `ERR_APP_NOT_FOUND` (404)
  - `ERR_APP_NOT_APPROVED` (400)
- **Действие инвестора:** Выбор другой заявки или обращение к администратору

### **E3: Недостаток средств у инвестора**
- **Обнаружение:** На этапе `IPaymentService.processPayment()`
- **Ответ платежного шлюза:** `INSUFFICIENT_FUNDS`
- **Обработка:** 
  - Статус гранта = "PAYMENT_FAILED"
  - Уведомление инвестору о необходимости пополнения счета
  - Предложение отложить выплату

### **E4: Сбой банковского перевода (технический)**
```
PaymentGatewayAPI → IPaymentService: Result(failure)
IPaymentService → GrantSystemFacade: false
```
- **Стратегия повтора:** Автоматический повтор через 5 минут (до 3 попыток)
- **Эскалация:** После 3 неудач → уведомление администратору
- **Статус:** "PAYMENT_RETRY_PENDING"

### **E5: Неверные реквизиты соискателя**
- **Обнаружение:** При валидации в `PaymentGatewayAPI`
- **Код ошибки:** `INVALID_RECIPIENT_DATA`
- **Действие:** 
  - Требование обновить банковские данные
  - Приостановка выплаты до исправления
  - Уведомление соискателю о необходимости актуализации данных

## **Специальные требования и их реализация**

| Требование | Реализация в диаграмме | Техническая детализация |
|------------|----------------------|-------------------------|
| **Двухфакторная аутентификация** | `GrantSystemFacade.login()` | Интегрировано с `служба авторизации` |
| **Ограничение по IP** | На уровне сети перед `GrantSystemUI` | Не показано (инфраструктурный уровень) |
| **TLS 1.3+ шифрование** | Все внешние вызовы (`PaymentGatewayAPI`, `EmailServiceAPI`) | Используются HTTPS-вызовы |
| **Интеграция с банковскими API** | `PaymentService → PaymentGatewayAPI` | REST API с OAuth2.0 аутентификацией |
| **Аудиторский лог** | Все операции с `save()`/`update()` в репозиториях | Логирование в БД с метаданными (кто, когда, что) |
| **Ежедневный бэкап** | На уровне `database` в репозиториях | Автоматическое резервное копирование |

## **Технологии и типы данных**

### **Идентификаторы и форматы:**
- `appId`: `uInt32` (идентификатор заявки)
- `grantId`: `uInt32` (идентификатор гранта, автоинкремент)
- `applicantId`: `uInt32` (идентификатор соискателя)
- `investorId`: `uInt32` (идентификатор инвестора, из сессии)
- `amount`: `decimal(15,2)` (сумма с точностью до копеек)
- `transactionDate`: `DateTime` (UTC timestamp)

### **Интеграционные точки:**
1. **AccountingService** → `GrantRepository` (финансовый учет)
2. **NotificationService** → `INotifyService` (коммуникации)
3. **BankAPI** → `PaymentGatewayAPI` (платежный шлюз)
4. **AuthService** → Неявно через `GrantSystemFacade.login()`

### **Хранение данных:**
- **Основные данные:** `Grant`, `GrantApplication` таблицы
- **Шифрование:** Поле `amount` и реквизиты в зашифрованном виде
- **Индексы:** По `status`, `investorId`, `applicantId` для отчетности

## **Частота использования и нагрузка**

### **Регулярная нагрузка:**
- **Средняя:** 10-20 операций/день в периоды между грантовыми циклами
- **Пиковая:** 100-200 операций/час при массовых выплатах
- **Время обработки:** 2-5 секунд на операцию (зависит от банковского API)

### **Оптимизации:**
1. **Асинхронные уведомления:** `INotifyService` работает через очередь сообщений
2. **Кэширование:** Часто используемые данные заявок в Redis
3. **Пакетная обработка:** Возможность массовых выплат (не показана в диаграмме)
4. **Ретри-логика:** Для платежных операций с экспоненциальной задержкой

## **Открытые вопросы и решения**

### **Q1: Лимит на разовую выплату для инвестора**
- **Решение:** Добавить проверку в `GrantSystemFacade.approveApplication()`:
  ```
  if (amount > investor.getMaxSinglePayment()) {
      throw new PaymentLimitExceededException();
  }
  ```
- **Реализация:** Поле `maxSinglePayment` в агрегате `Investor`

### **Q2: Поддержка частичных выплат гранта**
- **Решение:** Расширить модель `Grant`:
  ```
  class Grant {
      + totalAmount
      + disbursedAmount
      + disbursements: List<Disbursement>
      + partialDisburse(amount): boolean
  }
  ```
- **Изменения в диаграмме:** Цикл выплат с накоплением `disbursedAmount`

### **Q3: Интеграция с налоговой отчетностью**
- **Решение:** Добавить налоговый модуль:
  ```
  interface ITaxService {
      + generateTaxReport(grant): TaxDocument
      + submitToTaxAuthority(document): boolean
  }
  ```
- **Интеграция:** После успешной выплаты гранта

## **Риски и митигация**

| Риск | Вероятность | Влияние | Митигация |
|------|------------|---------|-----------|
| **Сбой платежного шлюза** | Средняя | Высокое | Ретри-логика, ручной процесс fallback |
| **Расхождение данных** | Низкая | Среднее | Регулярная сверка с банковскими выписками |
| **Мошеннические операции** | Низкая | Критическое | Многофакторная аутентификация, лимиты, аудит |
| **Потеря уведомлений** | Средняя | Низкое | Очередь сообщений с подтверждением доставки |

## **Заключение**

Диаграмма последовательности детально описывает процесс выдачи гранта, соответствующий всем требованиям из технического задания. Она демонстрирует:

1. **Полный цикл** от утверждения инвестором до подтверждения выплаты
2. **Интеграцию** всех необходимых компонентов системы
3. **Обработку ошибок** и альтернативные сценарии
4. **Соблюдение требований** безопасности и аудита
5. **Масштабируемость** для пиковых нагрузок

Процесс проектирован с учетом лучших практик финансовых систем: идемпотентность операций, атомарность обновлений данных, разделение ответственности между слоями приложения.
