@startuml
actor "Независимый эксперт" as Expert
participant "UI" as UI
participant "ExpertiseManagementFacade" as Facade
participant "IExpertiseRepository" as ExpertiseRepo
participant "IGrantApplicationRepository" as ApplicationRepo
participant "NotificationService" as NotifyService
participant "AuthorizationService" as AuthService
participant "ExpertiseAdapter" as ExpertiseAdapter
participant "ExpertiseServiceAPI" as ExpertiseAPI
participant "Database" as DB

Expert -> UI: Авторизоваться как эксперт
UI -> Facade: Authenticate(expertId: uInt32)
Facade -> AuthService: ValidateAccess(expertId: uInt32, role: "Expert")
AuthService --> Facade: AccessGranted
Facade --> UI: Успешная авторизация

Expert -> UI: Получить список заявок, назначенных на экспертизу
UI -> Facade: GetAssignedApplications(expertId: uInt32)
Facade -> AuthService: ValidateAccess(expertId: uInt32, role: "Expert")
AuthService --> Facade: AccessGranted

Facade -> ExpertiseRepo: FindAssignedApplications(expertId: uInt32)
ExpertiseRepo -> DB: SELECT a.* FROM grant_applications a\nJOIN expertise_assignments ea ON a.id = ea.application_id\nWHERE ea.expert_id = expertId AND ea.status = 'assigned'
DB --> ExpertiseRepo: Список заявок
ExpertiseRepo --> Facade: List<Application>

Facade -> UI: Отправить список заявок
UI --> Expert: Отображает список заявок

Expert -> UI: Выбрать заявку и начать оценку
UI -> Facade: StartExpertiseReview(applicationId: uInt32)
Facade -> AuthService: ValidateAccess(expertId: uInt32, role: "Expert")
AuthService --> Facade: AccessGranted

Facade -> ApplicationRepo: FindById(applicationId: uInt32)
ApplicationRepo -> DB: SELECT * FROM grant_applications WHERE id = applicationId
DB --> ApplicationRepo: Application data
ApplicationRepo --> Facade: Application object

Facade -> UI: Отправить данные заявки и шаблон заключения
UI --> Expert: Отображает документы и форму экспертизы

Expert -> UI: Заполнить заключение и отправить результат
UI -> Facade: SubmitExpertiseResult(applicationId: uInt32, result: ExpertiseResult)
Facade -> AuthService: ValidateAccess(expertId: uInt32, role: "Expert")
AuthService --> Facade: AccessGranted

Facade -> ExpertiseRepo: SaveExpertiseResult(applicationId: uInt32, result: ExpertiseResult)
ExpertiseRepo -> DB: INSERT INTO expertise_reviews (application_id, expert_id, verdict, score, comments, review_date)
DB --> ExpertiseRepo: Результат сохранён
ExpertiseRepo --> Facade: Подтверждение

Facade -> ExpertiseAdapter: FinalizeApplicationReview(applicationId: uInt32, verdict: Verdict)
ExpertiseAdapter -> ExpertiseAPI: finalizeReview(applicationId, verdict)
ExpertiseAPI --> ExpertiseAdapter: OK
ExpertiseAdapter --> Facade: Успешно

Facade -> NotifyService: NotifyApplicant(applicationId, "Завершена техническая экспертиза заявки")
NotifyService --> Facade: Уведомление отправлено

Facade -> UI: Обновить статус заявки
UI --> Expert: Статус: "Экспертиза завершена"

@enduml